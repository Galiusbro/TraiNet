# TrainNet.ai — MVP

## Общее описание проекта

TrainNet.ai — это платформа для распределенного обучения моделей машинного обучения. Проект позволяет пользователям загрузить датасет, выбрать модель, запустить обучение и получить готовую обученную модель. Основные компоненты системы включают фронтенд, бэкенд, распределенные воркеры и финализатор, которые вместе формируют полноценный пайплайн обучения моделей.

## Архитектура

Проект разделен на несколько основных компонентов:

- **Frontend**: React-приложение, предоставляющее пользовательский интерфейс для работы с платформой.
- **Backend**: FastAPI-сервер, обрабатывающий запросы от фронтенда, управляющий задачами и их статусами.
- **Worker**: Python-скрипт, выполняющий обучение на отдельных шардах (частях) датасета.
- **Finalizer**: Сервис, который собирает результаты от нескольких воркеров, усредняет веса моделей и формирует конечную модель.

Взаимодействие между компонентами осуществляется через REST API и очереди задач в Redis.

## Технологический стек

- **Frontend**: React, Tailwind CSS, Axios
- **Backend**: FastAPI, Supabase (PostgreSQL), Redis
- **Workers & Finalizer**: PyTorch, Transformers, Redis
- **Infrastructure**: Docker, Docker Compose

## Компоненты системы

### Frontend

Минималистичный пользовательский интерфейс с тремя основными страницами:

#### 1. Страница обучения (`/train`)

- **Функции**:
  - Загрузка датасета (CSV или JSON до 10MB) с использованием drag-and-drop интерфейса
  - Выбор модели из предложенных вариантов (MobileNetV2, DistilBERT)
  - Запуск процесса обучения
- **UI-элементы**:
  - Селектор модели
  - Область для загрузки файла (drag-and-drop)
  - Индикатор прогресса загрузки
  - Кнопка "Обучить модель"
- **Особенности**:
  - Датасет загружается в Supabase Storage для дальнейшего использования
  - Валидация формата и размера файлов
  - Простой интерфейс без сложного конфигурирования гиперпараметров

#### 2. Страница статуса (`/status/:taskId`)

- **Функции**:
  - Отображение текущего статуса задачи обучения
  - Индикация прогресса
  - Скачивание готовой модели
- **UI-элементы**:
  - Карточка с информацией о задаче (идентификатор, тип модели)
  - Индикатор статуса с цветовой кодировкой
  - Кнопка скачивания модели (появляется только для завершенных задач)
- **Особенности**:
  - Автоматическое обновление статуса каждые 5 секунд
  - Поддержка всех статусов задачи (pending, queued, running, done, error)

#### 3. Страница воркеров (`/workers`)

- **Функции**:
  - Тестовая панель для мониторинга подключенных воркеров
- **Особенности**:
  - Не является критической для MVP, скрыта от основного пользовательского потока

#### Общие характеристики Frontend

- Не требует аутентификации пользователей для MVP
- Responsive design, оптимизирован для различных устройств
- Лаконичный дизайн с использованием Tailwind CSS
- Отсутствие сложных и запутанных настроек

### Backend (FastAPI)

REST API-сервер, обрабатывающий задачи обучения, файлы и статусы.

#### Основные эндпоинты API:

| Метод | Путь                                | Описание                                                         |
| ----- | ----------------------------------- | ---------------------------------------------------------------- |
| GET   | /api/                               | Проверка работоспособности API                                   |
| POST  | /api/train                          | Запуск новой задачи обучения                                     |
| GET   | /api/tasks                          | Получение списка всех задач                                      |
| GET   | /api/tasks/{task_id}                | Получение информации о конкретной задаче                         |
| GET   | /api/tasks/{task_id}/status         | Проверка статуса задачи                                          |
| PATCH | /api/tasks/{task_id}/status         | Обновление статуса задачи (используется воркерами/финализатором) |
| GET   | /api/tasks/{task_id}/download_model | Скачивание обученной модели                                      |
| GET   | /api/models                         | Получение списка всех моделей                                    |
| GET   | /api/models/{model_id}              | Получение информации о конкретной модели                         |

#### Функциональность:

- **Управление задачами**:

  - Создание новых задач обучения
  - Шардирование датасета на несколько частей
  - Распределение шардов через Redis
  - Отслеживание статуса выполнения задач

- **Обработка файлов**:

  - Получение URL загруженного датасета из Supabase Storage
  - Предоставление доступа к обученным моделям для скачивания

- **Интеграция с Supabase**:

  - Хранение метаданных задач и моделей
  - Управление статусами задач

- **Работа с Redis**:
  - Создание очередей задач для воркеров
  - Хранение служебной информации о шардах и их количестве

### Worker

Python-скрипт для обучения моделей на отдельных шардах датасета.

#### Функциональность `shard_worker.py`:

- **Получение задач**:

  - Подключение к Redis и мониторинг очередей задач
  - Получение шардов из соответствующих очередей (BLPOP)

- **Обработка датасета**:

  - Скачивание полного датасета по URL
  - Извлечение соответствующего шарда (части датасета)
  - Преобразование данных в формат для обучения

- **Обучение модели**:

  - Поддержка различных архитектур (DistilBERT для текста, MobileNetV2 для изображений)
  - Настройка параметров обучения на основе переданных гиперпараметров
  - Выполнение процесса обучения с помощью PyTorch

- **Сохранение результатов**:
  - Сохранение весов обученной модели локально
  - Запись пути к файлу в Redis для последующей обработки финализатором

#### Особенности воркеров:

- **Горизонтальное масштабирование**:

  - Воркеры могут быть запущены на различных машинах/контейнерах
  - Возможность подключения и отключения воркеров во время работы системы
  - Автоматическое распределение нагрузки между доступными воркерами

- **Отказоустойчивость**:
  - Обработка ошибок соединения с Redis
  - Повторные попытки при возникновении сбоев
  - Изоляция ошибок одних шардов от других

### Finalizer

Служба, отвечающая за сборку и объединение результатов обучения от различных воркеров.

#### Функциональность `finalizer.py`:

- **Мониторинг результатов**:

  - Периодическая проверка Redis на наличие результатов от всех шардов задачи
  - Определение завершенности обработки всех шардов

- **Сборка модели**:

  - Загрузка весов всех шардов
  - Усреднение весов для получения финальной модели (`average_weights`)
  - Сохранение финальной модели локально

- **Уведомление о результатах**:

  - Обновление статуса задачи в бэкенде через API
  - Передача информации о файле с итоговой моделью

- **Очистка**:
  - Удаление временных файлов весов шардов
  - Очистка соответствующих ключей в Redis

#### Особенности финализатора:

- **Автономность**:

  - Работает независимо от воркеров и бэкенда
  - Автоматически определяет момент, когда все шарды задачи обработаны

- **Обработка ошибок**:
  - Проверка наличия и доступности всех файлов с весами
  - Логирование проблем и ошибок
  - Возможность переподключения к Redis при потере соединения

## Процесс работы

1. **Создание задачи**:

   - Пользователь загружает датасет и выбирает модель через фронтенд
   - Фронтенд загружает файл в Supabase Storage и получает публичный URL
   - Фронтенд отправляет запрос на создание задачи в бэкенд с параметрами и URL датасета

2. **Подготовка и распределение**:

   - Бэкенд создает запись о задаче в Supabase с начальным статусом
   - Бэкенд скачивает датасет, определяет его размер и разбивает на шарды
   - Информация о шардах помещается в очереди Redis с соответствующими параметрами

3. **Обучение**:

   - Воркеры извлекают шарды из очередей Redis
   - Каждый воркер скачивает датасет, выделяет свою часть и обучает модель
   - Воркеры сохраняют веса в локальные файлы и записывают пути в Redis

4. **Финализация**:

   - Финализатор отслеживает прогресс обработки шардов через Redis
   - Когда все шарды готовы, финализатор загружает все веса и усредняет их
   - Результирующая модель сохраняется локально
   - Финализатор уведомляет бэкенд о завершении задачи

5. **Получение результатов**:
   - Фронтенд периодически проверяет статус задачи через бэкенд
   - Когда задача завершена, фронтенд отображает ссылку для скачивания модели
   - Пользователь может скачать готовую модель через эндпоинт /api/tasks/{task_id}/download_model

## Ограничения MVP

- Отсутствует система аутентификации и авторизации пользователей
- Нет системы оплаты (предусмотрена интеграция со Stripe в будущем)
- Ограниченный набор доступных моделей (MobileNetV2, DistilBERT)
- Ограничение на размер загружаемых файлов (10MB)
- Нет визуализации процесса обучения (графики, метрики)
- Локальное хранение обученных моделей вместо облачного (для масштабирования рекомендуется перейти на S3/Supabase Storage)

## Дальнейшее развитие

- Добавление аутентификации и управления пользователями
- Интеграция с платежной системой (Stripe)
- Расширение набора доступных моделей и возможностей их настройки
- Улучшение UI/UX, добавление дашбордов и визуализаций
- Миграция на облачное хранение моделей
- Добавление системы мониторинга и логирования
- Оптимизация производительности и масштабируемости
